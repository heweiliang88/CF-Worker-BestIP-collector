name: Update Fast IPs

on:
  schedule:
    # 每6小时运行一次 (UTC时间)
    - cron: '0 */6 * * *'
  workflow_dispatch: # 允许手动触发
  push:
    paths:
      - '.github/workflows/update-fast-ips.yml'

jobs:
  update-ips:
    runs-on: ubuntu-latest
    
    # ⚠️ 关键：设置写入权限
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # ⚠️ 关键：使用有写入权限的 token
          token: ${{ secrets.GITHUB_TOKEN }}
          # 指定分支（根据你的仓库调整）
          ref: main
          
      - name: Download fast-ips.txt
        run: |
          echo "下载 fast-ips.txt 文件..."
          # 使用 -L 跟随重定向，-f 失败时退出
          curl -L -f -o fast-ips.txt "https://cf-speed.heweiliang88888.workers.dev/fast-ips.txt?token=B0tmhpMqbWZhtlavMPv2GugaRPGf2HNV"
          
          # 检查文件是否下载成功
          if [ ! -f "fast-ips.txt" ]; then
            echo "错误: 文件下载失败"
            exit 1
          fi
          
          file_size=$(wc -l < fast-ips.txt 2>/dev/null || echo "0")
          echo "文件大小: $file_size 行"
          echo "文件内容预览:"
          head -5 fast-ips.txt
          
      - name: Configure Git
        run: |
          git config --global user.name "heweiliang88"
          git config --global user.email "15816073129@163.com"
          
      - name: Check for changes
        id: check_changes
        run: |
          git status --porcelain
          if [ -n "$(git status --porcelain)" ]; then
            echo "有文件变更"
            echo "::set-output name=changes::true"
          else
            echo "没有文件变更"
            echo "::set-output name=changes::false"
          fi
          
      - name: Commit and push changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git add fast-ips.txt
          git commit -m "自动更新 fast-ips.txt [$(date -u +'%Y-%m-%d %H:%M:%S UTC')]"
          git push origin main
          
      - name: No changes
        if: steps.check_changes.outputs.changes == 'false'
        run: |
          echo "文件没有变化，跳过提交"
